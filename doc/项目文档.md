# file-flow-service 项目文档

## 1. 项目概述

### 1.1 项目简介
file-flow-service 是一个基于Go语言开发的文件执行平台，采用Web架构设计。该平台允许用户上传可执行文件，通过沙盒环境安全执行，并管理执行过程中的文件和日志。

### 1.2 技术栈
- 后端：Go 1.24.5
- 前端：Vue 3 + Element Plus
- 数据库：未指定（可扩展）
- 日志：Zap日志库
- 配置：YAML格式配置文件

### 1.3 项目架构
```
file-flow-service/
├── config/              # 配置模块
├── log/                 # 日志模块
├── utils/               # 工具模块
├── internal/            # 内部服务模块
├── file/                # 文件管理模块
├── sandbox/             # 沙箱执行模块
├── web/                 # Web模块
└── main.go              # 入口文件
```

### 1.5 前端组件结构
前端基于Vue 3 + Element Plus构建，主要组件结构如下：
- **路由**：`src/router/index.ts` 定义应用路由。
- **视图组件**：`src/views/` 目录包含页面组件，如`Home.vue`（首页）、`FileManager.vue`（文件管理）、`TaskManager.vue`（任务管理）等。
- **可复用组件**：`src/components/` 目录包含通用组件，如`PermissionWrapper.vue`（权限包装器）。
- **服务层**：`src/services/` 目录提供API服务，如`authService.ts`（认证服务）、`fileFlowApi.ts`（文件流API）。
- **状态管理**：`src/store/` 管理应用状态。

前端API调用示例：
- 上传文件：`fileFlowApi.uploadFile(file)`
- 获取任务列表：`fileFlowApi.getTasks()`

详细前端API说明请参考[`前端API文档`](doc/FRONTEND_API.md)。

### 1.4 项目实际实现模块
本项目实际实现的模块包括：
1）日志模块
    已实现记录日志的功能，并且以一天为基准分割日志文件存放。
    包含平台运行日志和文件执行时日志，两个日志在日志存放文件夹内分别存放。
    日志文件夹与项目启动文件在同一级，日志文件夹名称为log，并分别为service日志和flow日志，其中service日志存放平台日志，flow日志存放文件执行日志。
    在日志模块内生成了全局对象，供平台其他模块调用并记录日志。
    实现文件：utils/logger/logger.go

2）配置模块
    项目包含config.yaml配置文件，其中编写了平台各模块参数。
    实现了配置文件中参数的热更新功能，可以动态调整部分参数并且实时调整对应模块。
    将config.yaml文件内各参数对象化，并封装为一个全局对象，供平台其他模块调用获取相应参数。
    实现文件：config/config.go, config/hot_reload.go

3）权限模块
    根据登录人的权限，确定其可以使用平台的哪些功能，只能使用分配给其的权限，没有权限不能执行、查看到功能。
    实现文件：permission/permission.go, permission/auth.go

4）web模块
    根据后台功能编写了前端文件，使用vue3搭建，element-plus为前端框架。
    实现主页、登录、文件管理器、文件执行、日志查看等功能。
    实现文件：web/web_interface.go, web/websocket.go

5）线程池模块
    搭建了线程池，用于平台多线程执行文件。
    实现文件：internal/threadpool/pool.go

6）文件模块
    实现在web页面上上传被执行文件、配套文件，下载执行后的结果文件。
    实现文件：file/filemanager.go

7）主要业务
    1.使用沙盒功能将被执行的文件放入其中执行，并且网络环境采用运行本项目的主机。
    2.在执行之前将所需要的配套文件与被执行文件放置在一起，并且需要下载执行后生成的结果文件。
    3.将执行过程日志单独在平台的日志文件夹内存放，同时本平台的日志也存放在日志文件夹内，区分沙盒日志和平台日志。
    4.在执行文件时，保留源文件，复制源文件到一个新增的文件夹内执行，并且在执行时锁定此文件夹防止其他用户修改此文件夹内文件。
    5.对执行的任务操作，比如强行停止任务等功能。
    实现文件：sandbox/execution/executor.go, sandbox/environments/environment_manager.go

8）平台性能监控
    包含平台本身各硬件监控，以及平台执行的任务监控，包含各种图表显示。
    实现文件：internal/service/monitor/monitor.go

### 1.5 平台运行逻辑
平台在运行初期，除了打包好的项目运行文件以及搭配的config.yaml配置文件以外，生成了以下配套文件夹用于平台内模块使用：
1）配置文件夹
    存放config.yaml文件
2）日志文件夹
    存放平台启动日志文件init.log包含平台启动后初始化日志模块前的日志，由于日志模块此时并未初始化完成，所以由go语言内置日志模块记录日志。
    还包含有两个文件夹，分别为service文件夹和flow文件夹，其中service文件夹存放平台初始化日志模块之后的所有日志；flow文件夹存放平台每次执行文件时被执行文件的日志，包括执行报错日志、执行命令行日志。按执行文件命名和执行日期分开。
3）上传的被执行文件存放文件夹
    此处存放用户上传至平台的被执行文件，按照上传时命名的项目名分项目存放。
4）执行时文件夹
    存放执行任务时的临时文件和执行环境。

## 2. 功能模块说明

### 2.1 日志模块 (utils/logger)
- **功能**：提供全局日志对象，支持按天分割日志
- **日志分类**：
  - service日志：平台运行日志
  - flow日志：文件执行日志
- **实现文件**：utils/logger/logger.go
- **核心方法**：
  - InitLogger()：初始化日志模块
  - GetLogger()：获取全局日志对象
  - 各级别日志记录方法：Debug, Info, Warn, Error, Fatal
  - InitModuleLoggers()：初始化模块日志记录器

### 2.1.1 日志模块详细说明
- **logger.go**: 提供全局日志对象，支持按天分割日志，区分`service`（平台日志）和`flow`（执行日志）。
  - 文件头部注释：
    ```
    // logger.go
    // 日志模块实现，提供全局日志对象
    // 用于记录平台运行日志和文件执行日志
    // 服务模块通过logger.GetLogger()获取日志对象
    ```
  - 基本方法：
    ```go
    // InitLogger 初始化日志模块
    // 创建日志目录，设置日志级别，初始化全局日志对象
    // 返回：错误信息
    func InitLogger() error

    // InitModuleLoggers 初始化模块日志记录器
    // 返回：错误信息
    func InitModuleLoggers() error
    ```

### 2.2 配置模块 (config)
- **功能**：加载和管理配置文件，提供全局配置对象
- **配置文件**：config/config.yaml
- **实现文件**：config/config.go, config/hot_reload.go
- **核心方法**：
  - InitConfig()：初始化配置
  - GetConfig()：获取全局配置对象
  - LoadConfig()：加载配置文件
  - ReloadConfig()：重新加载配置
  - 热更新机制：支持动态调整部分配置参数

### 2.2.1 配置模块详细说明

- **config.go**: 加载`config.yaml`，提供全局`Config`对象。
  - 文件头部注释：
    ```
    // config.go
    // 配置模块实现，加载config.yaml并提供全局配置对象
    // 通过Config全局变量访问配置参数
    ```
  - 基本方法：
    ```go
    // LoadConfig 加载配置文件
    // 参数：configPath 配置文件路径
    // 返回：错误信息
    func (c *AppConfig) LoadConfig(configPath string) error

    // ReloadConfig 重新加载配置
    // 参数：configPath 配置文件路径
    // 返回：错误信息
    func (c *AppConfig) ReloadConfig(configPath string) error

    // InitConfig 初始化配置模块
    // 参数：configPath 配置文件路径
    // 返回：错误信息
    func InitConfig(configPath string) error

    // GetConfig 获取全局配置对象
    // 返回：全局配置对象
    func GetConfig() *AppConfig
    ```

- **hot_reload.go**: 实现配置热更新，监听文件变化，动态调整参数。
  - 文件头部注释：
    ```
    // hot_reload.go
    // 配置热更新实现，支持动态调整参数
    // 通过监听config.yaml变化，实时更新配置
    ```
  - 基本方法：
    ```go
    // StartHotReload 启动热更新监听
    // 参数：configPath 配置文件路径, configChan 配置更新通道
    // 返回：错误信息
    func StartHotReload(configPath string, configChan chan *AppConfig) error
    ```

- **permission.go**: 权限配置管理，定义权限结构。
  - 文件头部注释：
    ```
    // permission.go
    // 权限模块实现，管理用户权限配置
    // 用于控制用户访问功能
    ```
  - 基本方法：
    ```go
    // NewPermissionChecker 创建权限检查器
    // 参数：config 配置对象, logger 日志记录器
    // 返回：权限检查器实例
    func NewPermissionChecker(config *AppConfig, logger logger.Logger) PermissionChecker

    // CheckPermission 检查用户权限
    // 参数：role 角色, permission 权限
    // 返回：是否具有权限
    func (p *PermissionCheckerImpl) CheckPermission(role string, permission string) bool

    // GetPermissionError 获取权限错误信息
    // 返回：权限错误信息
    func (p *PermissionCheckerImpl) GetPermissionError() string
    ```

### 2.3 权限模块 (permission)
- **功能**：基于角色的权限控制
- **角色定义**：Admin, Editor, Viewer
- **权限控制**：根据用户角色控制功能访问
- **实现文件**：permission/permission.go, permission/auth.go
- **核心方法**：
  - NewPermissionChecker()：创建权限检查器
  - CheckPermission()：检查用户权限
  - GetPermissionError()：获取权限错误信息

### 2.4 Web模块 (web)
- **功能**：提供HTTP接口和WebSocket通信
- **接口类型**：
  - 文件上传/下载
  - 任务管理（创建、查询、更新、删除）
  - 状态监控
  - 配置管理
  - 进程管理
  - 任务管理
  - 关闭和重启管理
- **实现文件**：web/web_interface.go, web/websocket.go
- **核心方法**：
  - NewWebInterface()：创建Web接口实例
  - SetupRoutes()：设置HTTP路由
  - handleUpload()：处理文件上传
  - handleDownload()：处理文件下载
  - handleHealthCheck()：处理健康检查
  - handleCreateTask()：处理创建任务
  - handleGetTasks()：处理获取任务列表
  - handleUpdateTask()：处理更新任务
  - handleDeleteTask()：处理删除任务
  - handleCancelTask()：处理取消任务
  - handleGetExecutorStatus()：处理获取执行器状态
  - handleGetLogs()：处理获取日志
  - handleGetConfigList()：处理获取配置列表
  - handleUpdateConfig()：处理更新配置
  - handleGracefulShutdown()：处理优雅关闭
  - handleForceShutdown()：处理强制关闭
  - handleRestart()：处理热重启
  - handleGetAllProcesses()：处理获取所有进程
  - handleGetProcess()：处理获取指定进程
  - handleTerminateProcess()：处理终止进程
  - handleRestartProcess()：处理重启进程
  - handleGetProcessStats()：处理获取进程统计
  - handleGetAllTasks()：处理获取所有任务
  - handleGetTask()：处理获取指定任务
  - handleRetryTask()：处理重试任务
  - handleGetTaskStats()：处理获取任务统计
  - handleGetThreadPoolStats()：处理获取线程池统计

### 2.5 线程池模块 (internal/threadpool)
- **功能**：提供并发执行能力
- **特性**：
  - 可配置的最大工作线程数
  - 任务队列管理
  - 任务超时控制
  - 动态线程数调整
- **实现文件**：internal/threadpool/pool.go
- **核心方法**：
  - NewThreadPool()：创建线程池
  - Submit()：提交任务
  - Shutdown()：关闭线程池
  - GetStats()：获取线程池统计信息

### 2.5.1 线程池模块详细说明
- **pool.go**: 实现线程池，用于并发执行文件。
  - 文件头部注释：
    ```
    // pool.go
    // 线程池实现，提供并发执行能力
    // 用于文件执行任务的并发处理
    ```
  - 基本方法：
    ```go
    // NewThreadPool 创建线程池
    // 参数：maxWorkers 最大工作线程数, taskTimeout 任务超时, logger 日志记录器
    // 返回：线程池实例
    func NewThreadPool(maxWorkers int, taskTimeout time.Duration, logger logger.Logger) (*ThreadPool, error)

    // Submit 提交任务
    // 参数：task 任务函数
    // 返回：错误信息
    func (tp *ThreadPool) Submit(task func()) error

    // Shutdown 关闭线程池
    // 返回：错误信息
    func (tp *ThreadPool) Shutdown() error

    // GetStats 获取线程池统计信息
    // 返回：统计信息
    func (tp *ThreadPool) GetStats() *ThreadPoolStats
    ```

### 2.6 文件模块 (file)
- **功能**：文件上传、下载和管理
- **特性**：
  - 支持文件上传和下载
  - 文件存储路径管理
  - 文件锁机制防止并发修改
- **实现文件**：file/filemanager.go
- **核心方法**：
  - NewFileManager()：创建文件管理器
  - Upload()：上传文件
  - Download()：下载文件
  - Delete()：删除文件
  - List()：列出文件

### 2.6.1 文件模块详细说明
- **filemanager.go**: 处理文件上传、下载，管理执行环境。
  - 文件头部注释：
    ```
    // filemanager.go
    // 文件管理模块，处理文件上传、下载
    // 管理执行环境文件夹
    ```
  - 基本方法：
    ```go
    // NewFileManager 创建文件管理器
    // 参数：config 配置对象, logger 日志记录器
    // 返回：文件管理器实例
    func NewFileManager(config *AppConfig, logger logger.Logger) *FileManager

    // Upload 上传文件
    // 参数：file 文件头
    // 返回：错误信息
    func (f *FileManager) Upload(file *multipart.FileHeader) error

    // Download 下载文件
    // 参数：fileID 文件ID
    // 返回：文件路径, 错误信息
    func (f *FileManager) Download(fileID string) (string, error)

    // Delete 删除文件
    // 参数：fileID 文件ID
    // 返回：错误信息
    func (f *FileManager) Delete(fileID string) error

    // List 列出文件
    // 返回：文件列表, 错误信息
    func (f *FileManager) List() ([]*FileInfo, error)
    ```

### 2.7 沙箱执行模块 (sandbox)
- **功能**：提供安全的文件执行环境
- **特性**：
  - Python和Java环境管理
  - 执行环境隔离
  - 任务执行目录管理
  - 执行过程日志记录
- **实现文件**：
  - sandbox/execution/executor.go
  - sandbox/environments/environment_manager.go
- **核心方法**：
  - NewSandboxExecutor()：创建沙箱执行器
  - Init()：初始化沙箱执行器
  - Execute()：执行任务
  - GetEnvironmentManager()：获取环境管理器

### 2.7.1 沙箱执行模块详细说明

- **executor.go**: 提供安全的文件执行环境。
  - 文件头部注释：
    ```
    // executor.go
    // 沙箱执行器实现
    // 提供安全的文件执行环境
    ```
  - 基本方法：
    ```go
    // NewSandboxExecutor 创建沙箱执行器
    // 返回：沙箱执行器实例
    func NewSandboxExecutor() *SandboxExecutor

    // Init 初始化沙箱执行器
    // 参数：config 配置对象, logger 日志记录器, envManager 环境管理器
    // 返回：错误信息
    func (se *SandboxExecutor) Init(config *AppConfig, logger logger.Logger, envManager *EnvironmentManager) error

    // Execute 执行任务
    // 参数：task 任务信息
    // 返回：执行结果, 错误信息
    func (se *SandboxExecutor) Execute(task *Task) (*ExecutionResult, error)
    ```

- **environment_manager.go**: 管理Python和Java环境。
  - 文件头部注释：
    ```
    // environment_manager.go
    // 环境管理器实现
    // 管理Python和Java环境
    ```
  - 基本方法：
    ```go
    // NewEnvironmentManager 创建环境管理器
    // 返回：环境管理器实例
    func NewEnvironmentManager() *EnvironmentManager

    // Init 初始化环境管理器
    // 参数：config 配置对象, logger 日志记录器
    // 返回：错误信息
    func (em *EnvironmentManager) Init(config *AppConfig, logger logger.Logger) error

    // GetPythonEnvironment 获取Python环境
    // 参数：version 版本
    // 返回：Python环境路径, 错误信息
    func (em *EnvironmentManager) GetPythonEnvironment(version string) (string, error)

    // GetJavaEnvironment 获取Java环境
    // 参数：version 版本
    // 返回：Java环境路径, 错误信息
    func (em *EnvironmentManager) GetJavaEnvironment(version string) (string, error)
    ```

### 2.8 监控模块 (internal/service/monitor)
- **功能**：平台性能监控
- **监控内容**：
  - 硬件资源使用情况
  - 任务执行状态
  - 系统健康检查
- **实现文件**：internal/service/monitor/monitor.go
- **核心方法**：
  - NewMonitor()：创建监控器
  - Start()：启动监控
  - GetStats()：获取监控统计信息

### 2.8.1 监控模块详细说明
- **monitor.go**: 提供平台性能监控功能。
  - 文件头部注释：
    ```
    // monitor.go
    // 性能监控模块，提供硬件和任务监控功能
    // 用于平台性能分析和任务执行监控
    ```
  - 基本方法：
    ```go
    // NewMonitor 创建监控器
    // 参数：config 配置对象, logger 日志记录器
    // 返回：监控器实例
    func NewMonitor(config *AppConfig, logger logger.Logger) *MonitorImpl

    // Start 启动监控
    // 参数：ctx 上下文
    // 返回：无
    func (m *MonitorImpl) Start(ctx context.Context)

    // GetStats 获取监控统计信息
    // 返回：统计信息
    func (m *MonitorImpl) GetStats() *MonitorStats
    ```

### 2.9 任务管理模块 (internal/taskmanager)
- **功能**：任务管理
- **特性**：
  - 任务创建、查询、更新、删除
  - 任务状态管理
  - 任务取消和重试
- **实现文件**：internal/taskmanager/task_manager.go
- **核心方法**：
  - NewTaskManager()：创建任务管理器
  - CreateTask()：创建任务
  - GetTasks()：获取任务列表
  - UpdateTask()：更新任务
  - DeleteTask()：删除任务
  - CancelTask()：取消任务
  - RetryTask()：重试任务

### 2.9.1 任务管理模块详细说明
- **task_manager.go**: 管理任务生命周期。
  - 文件头部注释：
    ```
    // task_manager.go
    // 任务管理器实现
    // 管理任务的创建、查询、更新、删除
    ```
  - 基本方法：
    ```go
    // NewTaskManager 创建任务管理器
    // 参数：config 配置对象, logger 日志记录器
    // 返回：任务管理器实例
    func NewTaskManager(config *AppConfig, logger logger.Logger) *TaskManager

    // CreateTask 创建任务
    // 参数：task 任务信息
    // 返回：任务ID, 错误信息
    func (tm *TaskManager) CreateTask(task *Task) (string, error)

    // GetTasks 获取任务列表
    // 参数：page 页码, pageSize 每页大小
    // 返回：任务列表, 错误信息
    func (tm *TaskManager) GetTasks(page int, pageSize int) ([]*Task, error)

    // UpdateTask 更新任务
    // 参数：task 任务信息
    // 返回：错误信息
    func (tm *TaskManager) UpdateTask(task *Task) error

    // DeleteTask 删除任务
    // 参数：taskID 任务ID
    // 返回：错误信息
    func (tm *TaskManager) DeleteTask(taskID string) error

    // CancelTask 取消任务
    // 参数：taskID 任务ID
    // 返回：错误信息
    func (tm *TaskManager) CancelTask(taskID string) error

    // RetryTask 重试任务
    // 参数：taskID 任务ID
    // 返回：错误信息
    func (tm *TaskManager) RetryTask(taskID string) error
    ```

### 2.10 进程管理模块 (internal/processmanager)
- **功能**：进程管理
- **特性**：
  - 进程查询
  - 进程终止
  - 进程重启
- **实现文件**：internal/processmanager/process_manager.go
- **核心方法**：
  - NewProcessManager()：创建进程管理器
  - GetAllProcesses()：获取所有进程
  - GetProcess()：获取指定进程
  - TerminateProcess()：终止进程
  - RestartProcess()：重启进程

### 2.10.1 进程管理模块详细说明
- **process_manager.go**: 管理进程生命周期。
  - 文件头部注释：
    ```
    // process_manager.go
    // 进程管理器实现
    // 管理进程的查询、终止、重启
    ```
  - 基本方法：
    ```go
    // NewProcessManager 创建进程管理器
    // 参数：config 配置对象, logger 日志记录器
    // 返回：进程管理器实例
    func NewProcessManager(config *AppConfig, logger logger.Logger) *ProcessManager

    // GetAllProcesses 获取所有进程
    // 返回：进程列表, 错误信息
    func (pm *ProcessManager) GetAllProcesses() ([]*ProcessInfo, error)

    // GetProcess 获取指定进程
    // 参数：pid 进程ID
    // 返回：进程信息, 错误信息
    func (pm *ProcessManager) GetProcess(pid int) (*ProcessInfo, error)

    // TerminateProcess 终止进程
    // 参数：pid 进程ID
    // 返回：错误信息
    func (pm *ProcessManager) TerminateProcess(pid int) error

    // RestartProcess 重启进程
    // 参数：pid 进程ID
    // 返回：错误信息
    func (pm *ProcessManager) RestartProcess(pid int) error
    ```

### 2.11 关闭管理模块 (internal/shutdown)
- **功能**：服务关闭管理
- **特性**：
  - 优雅关闭
  - 强制关闭
- **实现文件**：internal/shutdown/shutdown_manager.go
- **核心方法**：
  - NewShutdownManager()：创建关闭管理器
  - GracefulShutdown()：优雅关闭
  - ForceShutdown()：强制关闭

### 2.12 重启管理模块 (internal/restart)
- **功能**：服务重启管理
- **特性**：
  - 热重启
- **实现文件**：internal/restart/restart_manager.go
- **核心方法**：
  - NewRestartManager()：创建重启管理器
  - Restart()：重启服务

## 3. 配置说明

### 3.1 配

## 环境配置

**项目路径**  
根目录：`c:/goproject/file-flow-service`  
关键目录结构：  
- `config/`：配置文件目录（含 config.yaml）
- `doc/`：文档目录（含 API_ROUTES.md 等）
- `internal/`：核心服务目录（含 api.go、service.go 等）

**开发环境**  
- 时区：Asia/Shanghai (UTC+8)
- 编辑器：VSCode，已打开文件 `internal/service/api/api.go` 和 `web/web_interface.go`